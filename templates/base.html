<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Εβδομαδιαίο Πρόγραμμα</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
</head>
<body>
  <header>
    <div style="display:flex;align-items:center;gap:1.5rem;flex-wrap:wrap;">
  <h1 style="margin:0;">Εβδομαδιαίο Πρόγραμμα</h1>
      <div id="distinct-counter" style="font-size:2rem;font-weight:700;color:#2c7be5;">
        <!-- Will be populated -->
      </div>
    </div>
    <nav>
      <a href="/">Αρχική</a> |
      <a href="/api/export" target="_blank">Εξαγωγή JSON</a> |
      <a href="/export/ics" title="Λήψη αρχείου iCalendar (.ics) με τα προεπιλεγμένα του ακαδημαϊκού ημερολογίου">Εξαγωγή ICS</a> |
      <form method="post" action="/reset" style="display:inline;">
        <button type="submit" class="nav-reset">Επαναφορά</button>
      </form>
    </nav>
  </header>
  <main>
    {% block content %}{% endblock %}
  </main>
  <script>
  document.addEventListener('DOMContentLoaded', () => {
    // Initialize counter if value from server embedded
    const counterEl = document.getElementById('distinct-counter');
    const inactiveToggle = document.getElementById('inactive-toggle');
    const hideInactiveKey = 'hide_inactive_courses';
    function setCounter(n){
      if(!counterEl) return;
      const label = n === 1 ? 'μάθημα' : 'μαθήματα';
      counterEl.textContent = n + ' ' + label;
    }
    if (counterEl && window.__distinct_count__ !== undefined) setCounter(window.__distinct_count__);
    function setInactiveHidden(hidden) {
      document.body.classList.toggle('hide-inactive', hidden);
      if (inactiveToggle) {
        const showText = inactiveToggle.getAttribute('data-show-text') || 'Απόκρυψη Ανενεργών';
        const hideText = inactiveToggle.getAttribute('data-hide-text') || 'Εμφάνιση Ανενεργών';
        inactiveToggle.textContent = hidden ? hideText : showText;
        inactiveToggle.setAttribute('aria-pressed', hidden ? 'true' : 'false');
      }
    }
    if (inactiveToggle) {
      const stored = localStorage.getItem(hideInactiveKey);
      setInactiveHidden(stored === '1');
      inactiveToggle.addEventListener('click', () => {
        const nextHidden = !document.body.classList.contains('hide-inactive');
        setInactiveHidden(nextHidden);
        localStorage.setItem(hideInactiveKey, nextHidden ? '1' : '0');
      });
    }
    document.body.addEventListener('click', async (e) => {
      const btn = e.target.closest('button.remove-btn');
      if (!btn) return;
      e.preventDefault();
      const url = btn.getAttribute('data-remove');
      try {
        const resp = await fetch(url, {method: 'POST', headers: {'Accept':'application/json','X-Requested-With':'fetch'}});
        if (resp.ok) {
          const data = await resp.json();
          if (Array.isArray(data.toggled_ids)) {
            data.toggled_ids.forEach(id => {
              const item = document.querySelector(`li.course-item[data-course-id="${id}"]`);
              if (item) {
                const isActive = data.active === true;
                item.classList.toggle('inactive', !isActive);
                const btn = item.querySelector('button.remove-btn');
                if (btn) btn.textContent = isActive ? '✕' : '✓';
              }
            });
            if (counterEl && typeof data.distinct_remaining === 'number') setCounter(data.distinct_remaining);
          }
        }
      } catch(err) { console.error(err); }
    });
    document.body.addEventListener('click', async (e) => {
      const btn = e.target.closest('button.year-toggle, button.filter-toggle');
      if (!btn) return;
      const form = btn.closest('form');
      if (!form || !window.fetch) return;
      e.preventDefault();
      try {
        const resp = await fetch(form.action, {method: 'POST', headers: {'Accept':'application/json','X-Requested-With':'fetch'}});
        if (resp.ok) {
          const data = await resp.json();
          if (counterEl && typeof data.distinct_remaining === 'number') setCounter(data.distinct_remaining);
          location.reload();
        }
      } catch(err) { console.error(err); }
    });
  });
  </script>
  {% block scripts %}{% endblock %}
</body>
</html>